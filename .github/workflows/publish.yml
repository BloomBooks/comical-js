name: Publish to npm

on:
    push:
        branches:
            - master
    workflow_dispatch:
        inputs:
            publish:
                description: If true, publish to npm (OIDC). If false, just build/version.
                required: false
                default: false
                type: boolean
            build_number:
                description: Patch/build number to use for the published version (defaults to next highest number)
                required: false
                type: string
            first_patch:
                description: If no matching versions exist on npm for this major.minor, start patch at this value
                required: false
                default: "0"
                type: string

permissions:
    contents: read
    id-token: write
    actions: write

concurrency:
    group: npm-publish
    cancel-in-progress: false

# The reason for two separate jobs: we currently need to build using node 16.
# But the publish process needs a modern npm/node for OIDC/provenance.
# If and when the code/build is upgraded to use a higher node version, we could combine them.
jobs:
    build:
        runs-on: ubuntu-latest
        permissions:
            contents: read

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Node (build)
              uses: actions/setup-node@v4
              with:
                  # matches package.json
                  node-version: 16.20.2
                  cache: yarn

            - name: Install dependencies
              run: yarn --frozen-lockfile

            - name: Build
              run: yarn build

            - name: Upload dist artifact
              uses: actions/upload-artifact@v4
              with:
                  name: dist
                  path: dist/
                  if-no-files-found: error

    publish:
        runs-on: ubuntu-latest
        needs: build
        permissions:
            contents: read
            id-token: write
            actions: write

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Download dist artifact
              uses: actions/download-artifact@v4
              with:
                  name: dist
                  path: dist/

            - name: Setup Node (publish)
              uses: actions/setup-node@v4
              with:
                  node-version: 22
                  registry-url: https://registry.npmjs.org

            - name: Set version (major.minor from package.json; patch = next npm version)
              env:
                  BUILD_NUMBER: ${{ github.event_name == 'workflow_dispatch' && inputs.build_number || '' }}
                  FIRST_PATCH: ${{ github.event_name == 'workflow_dispatch' && inputs.first_patch || '0' }}
              run: node scripts/set-version-from-npm.js

            - name: Install clean-publish only
              run: npm i --no-save clean-publish@4.0.1

            - name: Diagnostics (publish auth)
              shell: bash
              run: |
                  set -euo pipefail
                  echo "node: $(node -v)"
                  echo "npm:  $(npm -v)"
                  echo "registry: $(npm config get registry)"
                  if [[ -n "${ACTIONS_ID_TOKEN_REQUEST_URL:-}" ]]; then
                      echo "OIDC request URL present"
                  else
                      echo "OIDC request URL MISSING"
                  fi
                  if [[ -n "${ACTIONS_ID_TOKEN_REQUEST_TOKEN:-}" ]]; then
                      echo "OIDC request token present"
                  else
                      echo "OIDC request token MISSING"
                  fi

            - name: Publish (OIDC trusted publishing)
              id: publish
              if: ${{ github.event_name == 'push' || inputs.publish == true || inputs.publish == 'true' }}
              shell: bash
              env:
                  NODE_AUTH_TOKEN: ""
              run: |
                  set -euo pipefail

                  LOG_FILE="$RUNNER_TEMP/clean-publish.log"
                  rm -f "$LOG_FILE"

                  # Avoid token-based auth config produced by actions/setup-node. For OIDC trusted
                  # publishing we want npm to use GitHub OIDC, not NODE_AUTH_TOKEN.
                  NPMRC_TMP="$(mktemp)"
                  echo "registry=https://registry.npmjs.org/" > "$NPMRC_TMP"
                  export NPM_CONFIG_USERCONFIG="$NPMRC_TMP"

                  # Run via npm (not yarn) to avoid Yarn forcing the yarnpkg registry.
                  # Run the local binary directly to avoid arg-forwarding issues.
                  # Then check output for the success marker we expect.
                  ./node_modules/.bin/clean-publish --package-manager npm -- --provenance --registry https://registry.npmjs.org/ 2>&1 | tee "$LOG_FILE"

                  rm -f "$NPMRC_TMP"

                  # npm prints a line like: "+ comicaljs@0.3.104" on successful publish.
                  grep -Eq '^\+ comicaljs@' "$LOG_FILE"

            - name: Trigger dependent builds
              if: ${{ steps.publish.outcome == 'success' }}
              uses: actions/github-script@v7
              with:
                  script: |
                      await github.rest.actions.createWorkflowDispatch({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        workflow_id: 'trigger-builds.yml',
                        ref: context.ref
                      })
