name: Publish to npm

on:
    workflow_dispatch:
        inputs:
            publish:
                description: If true, publish to npm (OIDC). If false, just build/version.
                required: false
                default: false
                type: boolean
            build_number:
                description: Patch/build number to use for the published version (defaults to next highest number)
                required: false
                type: string
            first_patch:
                description: If no matching versions exist on npm for this major.minor, start patch at this value
                required: false
                default: "0"
                type: string

permissions:
    contents: read
    id-token: write

concurrency:
    group: npm-publish
    cancel-in-progress: false

jobs:
    publish:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Node
              uses: actions/setup-node@v4
              with:
                  node-version: 16.20.2
                  cache: yarn

            - name: Upgrade npm (for provenance/OIDC)
              run: npm i -g npm@9

            - name: Install dependencies
              run: yarn --frozen-lockfile

            - name: Set version (major.minor from package.json; patch = next npm version)
              env:
                  BUILD_NUMBER: ${{ inputs.build_number }}
                  FIRST_PATCH: ${{ inputs.first_patch }}
              shell: bash
              run: |
                  node scripts/set-version-from-npm.js

            - name: Build
              run: yarn build

            - name: Publish (OIDC trusted publishing)
              if: ${{ inputs.publish == true || inputs.publish == 'true' }}
              run: yarn publish-clean
